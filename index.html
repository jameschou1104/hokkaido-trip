<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>北海道冬日之旅</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
            background: linear-gradient(to bottom, #e0f2fe 0%, #fff1f2 100%); /* 延伸圖片藍色到粉色的漸層 */
            overscroll-behavior-y: none;
        }
        /* 隱藏 Scrollbar 但保留功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* 模擬 App 的容器 */
        .app-container {
            max-width: 480px; /* 手機寬度限制 */
            margin: 0 auto;
            background-color: #f8fafc;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            padding-bottom: 80px;
        }
        /* 極簡日系卡片陰影 */
        .card-shadow {
            box-shadow: 0 4px 20px rgba(148, 163, 184, 0.15);
        }
        .weather-gradient {
            background: linear-gradient(135deg, #60a5fa 0%, #93c5fd 100%);
        }
    </style>
</head>
<body>

<div id="app" class="app-container">
    
    <header class="relative w-full h-[250px] overflow-hidden">
        <img src="首頁.jpg" alt="北海道首頁" class="w-full h-full object-cover object-center">
        
        <div class="absolute bottom-8 right-4 flex space-x-3 z-20">
            <button @click="currentTab = 'itinerary'" :class="currentTab === 'itinerary' ? 'bg-white text-blue-500' : 'bg-white/60 text-gray-500'" class="w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all backdrop-blur-sm">
                <i class="fa-solid fa-location-dot text-lg"></i>
            </button>
            <button @click="currentTab = 'info'" :class="currentTab === 'info' ? 'bg-white text-blue-500' : 'bg-white/60 text-gray-500'" class="w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all backdrop-blur-sm">
                <i class="fa-solid fa-circle-info text-lg"></i>
            </button>
            <button @click="currentTab = 'shopping'" :class="currentTab === 'shopping' ? 'bg-white text-blue-500' : 'bg-white/60 text-gray-500'" class="w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all backdrop-blur-sm">
                <i class="fa-solid fa-basket-shopping text-lg"></i>
            </button>
            <button @click="currentTab = 'expense'" :class="currentTab === 'expense' ? 'bg-white text-blue-500' : 'bg-white/60 text-gray-500'" class="w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all backdrop-blur-sm">
                <i class="fa-solid fa-sack-dollar text-lg"></i>
            </button>
        </div>
    </header>

    <div class="relative -mt-6 bg-[#f8fafc] rounded-t-[30px] px-5 pt-6 z-10 min-h-[500px]">

        <div v-show="currentTab === 'itinerary'">
            
            <div class="weather-gradient rounded-2xl p-4 text-white mb-6 flex items-center justify-between shadow-lg ring-4 ring-white">
                <div>
                    <div class="text-sm opacity-90"><i class="fa-solid fa-location-arrow mr-1"></i> 札幌 Sapporo</div>
                    <div class="text-3xl font-bold mt-1">-2°C</div>
                    <div class="text-xs opacity-80 mt-1">體感 -6°C</div>
                </div>
                <div class="text-center">
                    <i class="fa-solid fa-snowflake text-4xl animate-pulse"></i>
                    <div class="text-xs mt-2">小雪</div>
                </div>
            </div>

            <div class="flex space-x-4 overflow-x-auto no-scrollbar mb-6 pb-2">
                <div v-for="(day, index) in tripDays" :key="index" 
                     @click="selectedDateIndex = index"
                     :class="selectedDateIndex === index ? 'bg-blue-500 text-white shadow-blue-200' : 'bg-white text-gray-400'"
                     class="flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center shadow-sm transition-all cursor-pointer">
                    <span class="text-xs font-medium uppercase tracking-wider">{{ day.week }}</span>
                    <span class="text-2xl font-bold mt-1">{{ day.date }}</span>
                </div>
            </div>

            <div class="space-y-0 relative">
                <div class="absolute left-[26px] top-4 bottom-10 w-0.5 bg-gray-200 -z-0"></div>

                <div v-for="(item, index) in currentDayItinerary" :key="item.id" class="relative pb-8 group">
                    
                    <div v-if="selectedDateIndex === 0 && index === 0" class="pl-14 relative" @click="openMap(item.location)">
                        <div class="absolute left-0 top-0 w-14 flex flex-col items-center z-10">
                            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center ring-4 ring-[#f8fafc]">
                                <i class="fa-solid fa-plane-departure"></i>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-5 card-shadow border-l-4 border-blue-400">
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full">航班</span>
                                <span class="text-gray-400 text-xs">{{ item.time }}</span>
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg">{{ item.name }}</h3>
                            <div class="mt-2 flex justify-between text-sm text-gray-600">
                                <div><span class="text-gray-400">TPE</span> 10:00</div>
                                <i class="fa-solid fa-arrow-right text-gray-300"></i>
                                <div><span class="text-gray-400">CTS</span> 15:00</div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">{{ item.notes }}</p>
                        </div>
                    </div>

                    <div v-else class="pl-14 relative">
                         <div v-if="index > 0" class="absolute -top-6 left-14 flex items-center text-xs text-gray-400 bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">
                            <i :class="getTransportIcon(item.transportType)" class="mr-1"></i>
                            {{ item.travelTime }}
                        </div>
                        <div v-if="index === 0 && selectedDateIndex !== 0" class="absolute -top-6 left-14 flex items-center text-xs text-gray-400 bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">
                            <i class="fa-solid fa-hotel mr-1"></i> 從飯店出發: {{ item.travelTime }}
                        </div>

                        <div class="absolute left-0 top-0 w-14 flex flex-col items-center z-10">
                            <div :class="getCategoryColor(item.category)" class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md ring-4 ring-[#f8fafc] cursor-pointer" @click.stop="moveItem(index)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl p-4 card-shadow active:scale-95 transition-transform cursor-pointer" @click="openMap(item.name)">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-gray-800">{{ item.name }}</h3>
                                    <p class="text-xs text-gray-500 mt-1"><i class="fa-regular fa-clock mr-1"></i>{{ item.time }}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button @click.stop="editItinerary(item)" class="text-gray-300 hover:text-blue-500"><i class="fa-solid fa-pen-to-square"></i></button>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2 mt-3">
                                <span class="text-[10px] px-2 py-1 rounded-md bg-gray-100 text-gray-500">{{ item.category }}</span>
                                <span v-if="item.ticket" class="text-[10px] px-2 py-1 rounded-md bg-yellow-50 text-yellow-600">
                                    <i class="fa-solid fa-ticket mr-1"></i>{{ item.ticket }}
                                </span>
                            </div>
                            <p v-if="item.notes" class="text-xs text-gray-500 mt-2 border-t pt-2 border-dashed border-gray-100">
                                {{ item.notes }}
                            </p>
                        </div>
                        
                        <div class="absolute -right-2 top-10 flex flex-col space-y-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button @click.stop="moveUp(index)" v-if="index > 0" class="w-6 h-6 bg-white shadow rounded-full text-blue-400 text-xs"><i class="fa-solid fa-chevron-up"></i></button>
                            <button @click.stop="moveDown(index)" v-if="index < currentDayItinerary.length - 1" class="w-6 h-6 bg-white shadow rounded-full text-blue-400 text-xs"><i class="fa-solid fa-chevron-down"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <button @click="showAddModal = true; isEditing = false; resetForm()" class="fixed bottom-24 right-6 w-14 h-14 bg-blue-500 text-white rounded-full shadow-xl shadow-blue-300 flex items-center justify-center text-2xl hover:scale-110 transition-transform z-40">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div v-show="currentTab === 'info'" class="space-y-6 pb-20">
            
            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-coins text-yellow-500 mr-2"></i> 匯率換算 (今日)</h3>
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <label class="text-xs text-gray-400 block mb-1">日幣 (JPY)</label>
                        <input type="number" v-model="currencyJpy" @input="convertCurrency" class="w-full bg-gray-50 rounded-lg px-3 py-2 text-lg font-bold outline-none focus:ring-2 focus:ring-blue-200">
                    </div>
                    <i class="fa-solid fa-right-left text-gray-300"></i>
                    <div class="flex-1">
                        <label class="text-xs text-gray-400 block mb-1">台幣 (TWD)</label>
                        <input type="number" v-model="currencyTwd" readonly class="w-full bg-gray-50 rounded-lg px-3 py-2 text-lg font-bold text-gray-500">
                    </div>
                </div>
                <p class="text-[10px] text-gray-400 mt-2 text-right">匯率參考: 0.218</p>
            </div>

            <div class="bg-white rounded-2xl overflow-hidden card-shadow">
                <div class="bg-blue-50 px-5 py-3 border-b border-blue-100 flex justify-between items-center">
                    <h3 class="font-bold text-blue-800"><i class="fa-solid fa-plane mr-2"></i>航班資訊</h3>
                </div>
                <div class="p-5 space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800">TPE</div>
                            <div class="text-xs text-gray-400">10:00</div>
                        </div>
                        <div class="flex-1 px-4 text-center">
                            <div class="text-xs text-blue-500 font-bold mb-1">JX850</div>
                            <div class="h-0.5 bg-gray-200 relative">
                                <i class="fa-solid fa-plane absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-blue-300"></i>
                            </div>
                            <div class="text-[10px] text-gray-400 mt-1">4h 0m</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800">CTS</div>
                            <div class="text-xs text-gray-400">15:00</div>
                        </div>
                    </div>
                    <div class="border-t border-dashed border-gray-200 my-2"></div>
                    <div class="flex items-center justify-between">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800">CTS</div>
                            <div class="text-xs text-gray-400">16:30</div>
                        </div>
                        <div class="flex-1 px-4 text-center">
                            <div class="text-xs text-blue-500 font-bold mb-1">JX851</div>
                            <div class="h-0.5 bg-gray-200 relative">
                                <i class="fa-solid fa-plane absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-blue-300 rotate-180"></i>
                            </div>
                            <div class="text-[10px] text-gray-400 mt-1">4h 30m</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800">TPE</div>
                            <div class="text-xs text-gray-400">20:00</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white rounded-2xl p-4 card-shadow" @click="openMap('札幌格蘭大飯店')">
                    <i class="fa-solid fa-hotel text-2xl text-purple-400 mb-2"></i>
                    <h4 class="font-bold text-sm">札幌格蘭大飯店</h4>
                    <p class="text-xs text-gray-400 mt-1">011-261-3311</p>
                    <p class="text-[10px] text-blue-500 mt-2">點擊導航 ></p>
                </div>
                <div class="bg-white rounded-2xl p-4 card-shadow" @click="openMap('Toyota Rent a Car Sapporo')">
                    <i class="fa-solid fa-car text-2xl text-green-400 mb-2"></i>
                    <h4 class="font-bold text-sm">Toyota 租車</h4>
                    <p class="text-xs text-gray-400 mt-1">札幌站北口店</p>
                    <p class="text-[10px] text-blue-500 mt-2">點擊導航 ></p>
                </div>
            </div>

             <div class="bg-red-50 rounded-2xl p-4 border border-red-100">
                <h4 class="font-bold text-red-600 mb-2">緊急聯絡</h4>
                <div class="flex justify-between text-sm">
                    <span><i class="fa-solid fa-user-shield mr-2"></i>警察局: 110</span>
                    <span><i class="fa-solid fa-truck-medical mr-2"></i>救護車: 119</span>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'shopping'" class="pb-20">
            <h2 class="text-xl font-bold text-gray-800 mb-4 px-2">必買清單 Wishlist</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <div v-for="(item, index) in shoppingList" :key="index" class="bg-white rounded-2xl p-3 card-shadow relative">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-2 overflow-hidden relative">
                         <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                         <div v-else class="w-full h-full flex items-center justify-center text-gray-300"><i class="fa-solid fa-image text-2xl"></i></div>
                    </div>
                    <h4 class="font-bold text-gray-700 text-sm">{{ item.name }}</h4>
                    <button @click="shoppingList.splice(index, 1)" class="absolute top-2 right-2 w-6 h-6 bg-red-100 text-red-500 rounded-full flex items-center justify-center text-xs"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>

            <button @click="showShopModal = true" class="fixed bottom-24 right-6 w-14 h-14 bg-pink-500 text-white rounded-full shadow-xl shadow-pink-300 flex items-center justify-center text-2xl hover:scale-110 transition-transform z-40">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div v-show="currentTab === 'expense'" class="pb-20">
            <div class="bg-gradient-to-r from-blue-500 to-cyan-400 rounded-2xl p-6 text-white shadow-lg shadow-blue-200 mb-6">
                <div class="text-sm opacity-90">總花費 (TWD)</div>
                <div class="text-4xl font-bold mt-1">$ {{ totalExpenseTWD }}</div>
                <div class="mt-4 flex justify-between text-xs opacity-80">
                    <span>現金: {{ expenseCash }}</span>
                    <span>信用卡: {{ expenseCard }}</span>
                </div>
            </div>

            <div class="space-y-3">
                <div v-for="(exp, index) in expenses" :key="index" class="bg-white rounded-xl p-4 card-shadow flex justify-between items-center">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center mr-3 text-lg">
                            <i :class="getExpenseIcon(exp.category)" class="text-gray-500"></i>
                        </div>
                        <div>
                            <div class="font-bold text-gray-800">{{ exp.name }}</div>
                            <div class="text-xs text-gray-400">{{ exp.date }} · {{ exp.payment }}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-gray-800">¥{{ exp.amount }}</div>
                        <div class="text-xs text-gray-400">約 ${{ Math.round(exp.amount * 0.218) }}</div>
                    </div>
                </div>
            </div>

             <button @click="showExpModal = true" class="fixed bottom-24 right-6 w-14 h-14 bg-cyan-500 text-white rounded-full shadow-xl shadow-cyan-300 flex items-center justify-center text-2xl hover:scale-110 transition-transform z-40">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

    </div>

    <div v-if="showAddModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-slide-up">
            <h3 class="text-xl font-bold mb-4">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
            
            <div class="space-y-3">
                <select v-model="form.category" class="w-full bg-gray-50 p-3 rounded-lg border-none">
                    <option value="景點">景點</option>
                    <option value="美食">美食</option>
                    <option value="購物">購物</option>
                    <option value="住宿">住宿</option>
                    <option value="其他">其他</option>
                </select>
                <input v-model="form.name" type="text" placeholder="名稱" class="w-full bg-gray-50 p-3 rounded-lg border-none">
                <input v-model="form.time" type="time" class="w-full bg-gray-50 p-3 rounded-lg border-none">
                <input v-if="form.category === '景點'" v-model="form.ticket" type="text" placeholder="門票資訊" class="w-full bg-gray-50 p-3 rounded-lg border-none">
                <textarea v-model="form.notes" placeholder="備註" class="w-full bg-gray-50 p-3 rounded-lg border-none h-20"></textarea>
            </div>

            <div class="mt-6 flex space-x-3">
                <button v-if="isEditing" @click="deleteItinerary" class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                <button @click="showAddModal = false" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold">取消</button>
                <button @click="saveItinerary" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-bold">儲存</button>
            </div>
        </div>
    </div>

    <div v-if="showShopModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4">新增購物清單</h3>
            <input v-model="shopForm.name" type="text" placeholder="商品名稱" class="w-full bg-gray-50 p-3 rounded-lg mb-3">
            <label class="block w-full bg-gray-50 p-3 rounded-lg text-center text-gray-400 cursor-pointer border border-dashed border-gray-300">
                <i class="fa-solid fa-camera mr-2"></i>上傳圖片
                <input type="file" @change="handleImageUpload" class="hidden" accept="image/*">
            </label>
            <div v-if="shopForm.image" class="mt-2 text-center text-xs text-green-500">圖片已選取</div>
            <div class="mt-6 flex space-x-3">
                <button @click="showShopModal = false" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold">取消</button>
                <button @click="saveShopItem" class="flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold">新增</button>
            </div>
        </div>
    </div>

    <div v-if="showExpModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4">新增花費</h3>
            <div class="space-y-3">
                <select v-model="expForm.category" class="w-full bg-gray-50 p-3 rounded-lg">
                    <option value="飲食">飲食</option>
                    <option value="交通">交通</option>
                    <option value="購物">購物</option>
                    <option value="門票">門票</option>
                    <option value="住宿">住宿</option>
                    <option value="其他">其他</option>
                </select>
                <input v-model="expForm.name" type="text" placeholder="項目名稱" class="w-full bg-gray-50 p-3 rounded-lg">
                <input v-model="expForm.amount" type="number" placeholder="金額 (JPY)" class="w-full bg-gray-50 p-3 rounded-lg">
                <div class="flex space-x-2">
                     <button @click="expForm.payment = '現金'" :class="expForm.payment === '現金' ? 'bg-cyan-100 text-cyan-600' : 'bg-gray-50 text-gray-400'" class="flex-1 py-2 rounded-lg text-sm">現金</button>
                     <button @click="expForm.payment = '信用卡'" :class="expForm.payment === '信用卡' ? 'bg-cyan-100 text-cyan-600' : 'bg-gray-50 text-gray-400'" class="flex-1 py-2 rounded-lg text-sm">信用卡</button>
                </div>
            </div>
            <div class="mt-6 flex space-x-3">
                <button @click="showExpModal = false" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold">取消</button>
                <button @click="saveExpense" class="flex-1 bg-cyan-500 text-white py-3 rounded-xl font-bold">紀錄</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, reactive, computed, ref } = Vue;

    createApp({
        setup() {
            const currentTab = ref('itinerary');
            const selectedDateIndex = ref(0);
            
            // 模擬旅程日期
            const tripDays = [
                { week: 'FRI', date: '6' },
                { week: 'SAT', date: '7' },
                { week: 'SUN', date: '8' },
                { week: 'MON', date: '9' },
                { week: 'TUE', date: '10' }
            ];

            // 假資料：行程 (巢狀陣列，對應 index)
            const itineraryData = reactive([
                // Day 1
                [
                    { id: 1, category: '航班', name: '出發前往北海道', time: '10:00', notes: '記得帶護照，JX850', transportType: 'flight' },
                    { id: 2, category: '住宿', name: '札幌格蘭大飯店 Check-in', time: '16:00', travelTime: '50分鐘', transportType: 'train' },
                    { id: 3, category: '美食', name: '湯咖哩 GARAKU', time: '18:00', travelTime: '10分鐘', transportType: 'walk', notes: '排隊名店' }
                ],
                // Day 2
                [
                    { id: 4, category: '景點', name: '大通公園', time: '09:00', travelTime: '10分鐘', transportType: 'walk', ticket: '免費' },
                    { id: 5, category: '美食', name: '二條市場 海鮮丼', time: '12:00', travelTime: '15分鐘', transportType: 'walk' },
                    { id: 6, category: '購物', name: '狸小路商店街', time: '14:00', travelTime: '5分鐘', transportType: 'walk' }
                ],
                [], [], [] // 其他天
            ]);

            // 當前日期的行程
            const currentDayItinerary = computed(() => {
                return itineraryData[selectedDateIndex.value] || [];
            });

            // 表單控制
            const showAddModal = ref(false);
            const isEditing = ref(false);
            const editingId = ref(null);
            const form = reactive({ category: '景點', name: '', time: '', ticket: '', notes: '' });
            
            // 購物控制
            const showShopModal = ref(false);
            const shoppingList = reactive([
                { name: '六花亭 葡萄奶油夾心餅', image: null },
                { name: '白色戀人', image: null }
            ]);
            const shopForm = reactive({ name: '', image: null });

            // 花費控制
            const showExpModal = ref(false);
            const expenses = reactive([
                { category: '交通', name: 'JR 機場快線', date: 'Fri 6', amount: 1150, payment: '現金' }
            ]);
            const expForm = reactive({ category: '飲食', name: '', amount: '', payment: '現金' });

            // 匯率
            const currencyJpy = ref(1000);
            const currencyTwd = ref(218);
            const convertCurrency = () => {
                currencyTwd.value = Math.round(currencyJpy.value * 0.218);
            };

            // 行程功能
            const resetForm = () => {
                Object.assign(form, { category: '景點', name: '', time: '', ticket: '', notes: '' });
            };

            const editItinerary = (item) => {
                isEditing.value = true;
                editingId.value = item.id;
                Object.assign(form, item);
                showAddModal.value = true;
            };

            const saveItinerary = () => {
                if (isEditing.value) {
                    const list = itineraryData[selectedDateIndex.value];
                    const index = list.findIndex(i => i.id === editingId.value);
                    if (index !== -1) {
                        Object.assign(list[index], form);
                    }
                } else {
                    // 新增
                    // 隨機計算交通時間 (模擬)
                    const transportOptions = ['walk', 'car', 'bus'];
                    const randomTransport = transportOptions[Math.floor(Math.random() * transportOptions.length)];
                    const randomTime = Math.floor(Math.random() * 20 + 5) + '分鐘';

                    itineraryData[selectedDateIndex.value].push({
                        id: Date.now(),
                        ...form,
                        travelTime: randomTime,
                        transportType: randomTransport
                    });
                }
                showAddModal.value = false;
            };

            const deleteItinerary = () => {
                if(confirm('確定要刪除這個行程嗎？')) {
                    const list = itineraryData[selectedDateIndex.value];
                    const index = list.findIndex(i => i.id === editingId.value);
                    list.splice(index, 1);
                    showAddModal.value = false;
                }
            };

            const moveUp = (index) => {
                const list = itineraryData[selectedDateIndex.value];
                [list[index - 1], list[index]] = [list[index], list[index - 1]];
            };
            const moveDown = (index) => {
                const list = itineraryData[selectedDateIndex.value];
                [list[index + 1], list[index]] = [list[index], list[index + 1]];
            };

            // 購物功能
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if(file) {
                    shopForm.image = URL.createObjectURL(file);
                }
            };
            const saveShopItem = () => {
                if(shopForm.name) {
                    shoppingList.push({ ...shopForm });
                    shopForm.name = '';
                    shopForm.image = null;
                    showShopModal.value = false;
                }
            };

            // 花費功能
            const saveExpense = () => {
                if(expForm.name && expForm.amount) {
                    expenses.push({
                        ...expForm,
                        date: tripDays[selectedDateIndex.value].week + ' ' + tripDays[selectedDateIndex.value].date,
                        amount: parseInt(expForm.amount)
                    });
                    showExpModal.value = false;
                    expForm.name = ''; expForm.amount = '';
                }
            };
            
            const totalExpenseTWD = computed(() => {
                return Math.round(expenses.reduce((sum, item) => sum + (item.amount * 0.218), 0));
            });
            const expenseCash = computed(() => {
                 let total = expenses.filter(i => i.payment === '現金').reduce((sum, i) => sum + (i.amount * 0.218), 0);
                 return Math.round(total);
            });
            const expenseCard = computed(() => {
                 let total = expenses.filter(i => i.payment === '信用卡').reduce((sum, i) => sum + (i.amount * 0.218), 0);
                 return Math.round(total);
            });

            // Helper Functions
            const openMap = (location) => {
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${location}`, '_blank');
            };

            const getCategoryColor = (cat) => {
                const map = { '景點': 'bg-green-400', '美食': 'bg-orange-400', '購物': 'bg-pink-400', '住宿': 'bg-purple-400', '航班': 'bg-blue-400', '其他': 'bg-gray-400' };
                return map[cat] || 'bg-blue-400';
            };
            const getCategoryIcon = (cat) => {
                 const map = { '景點': 'fa-camera', '美食': 'fa-utensils', '購物': 'fa-bag-shopping', '住宿': 'fa-bed', '航班': 'fa-plane', '其他': 'fa-star' };
                 return `fa-solid ${map[cat] || 'fa-map-pin'}`;
            };
            const getTransportIcon = (type) => {
                const map = { 'walk': 'fa-person-walking', 'car': 'fa-car', 'bus': 'fa-bus', 'train': 'fa-train' };
                return `fa-solid ${map[type] || 'fa-person-walking'}`;
            };
            const getExpenseIcon = (cat) => {
                 const map = { '飲食': 'fa-utensils', '交通': 'fa-train', '購物': 'fa-bag-shopping', '門票': 'fa-ticket', '住宿': 'fa-bed' };
                 return `fa-solid ${map[cat] || 'fa-coins'}`;
            };

            return {
                currentTab, selectedDateIndex, tripDays, itineraryData, currentDayItinerary,
                showAddModal, isEditing, form, editItinerary, saveItinerary, deleteItinerary, resetForm,
                moveUp, moveDown,
                currencyJpy, currencyTwd, convertCurrency,
                showShopModal, shoppingList, shopForm, handleImageUpload, saveShopItem,
                showExpModal, expenses, expForm, saveExpense, totalExpenseTWD, expenseCash, expenseCard,
                openMap, getCategoryColor, getCategoryIcon, getTransportIcon, getExpenseIcon
            };
        }
    }).mount('#app');
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂåóÊµ∑ÈÅìÂÜ¨Êó•‰πãÊóÖ</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
            background: linear-gradient(to bottom, #e0f2fe 0%, #fff1f2 100%);
            overscroll-behavior-y: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .app-container {
            width: 100%;
            margin: 0 auto;
            background-color: #f8fafc;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            padding-bottom: 80px;
        }
        .card-shadow { box-shadow: 0 4px 20px rgba(148, 163, 184, 0.15); }
        .weather-gradient { background: linear-gradient(135deg, #60a5fa 0%, #93c5fd 100%); }
    </style>
</head>
<body>

<div id="app" class="app-container">
    
    <header class="relative w-full h-[400px] overflow-hidden">
        <img :src="currentHeaderImage" alt="ÂåóÊµ∑ÈÅìÈ¶ñÈ†Å" class="w-full h-full object-cover object-center transition-all duration-500">
        
        <div class="absolute bottom-8 right-4 flex space-x-3 z-20">
    
    <button @click="currentTab = 'itinerary'" 
            :class="currentTab === 'itinerary' ? 'bg-white scale-110' : 'bg-white/80'" 
            class="w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all backdrop-blur-sm p-2">
        <img src="nav-map.png" class="w-full h-full object-contain">
    </button>

    <button @click="currentTab = 'info'" 
            :class="currentTab === 'info' ? 'bg-white scale-110' : 'bg-white/80'" 
            class="w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all backdrop-blur-sm p-2">
        <img src="nav-info.png" class="w-full h-full object-contain">
    </button>

    <button @click="currentTab = 'shopping'" 
            :class="currentTab === 'shopping' ? 'bg-white scale-110' : 'bg-white/80'" 
            class="w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all backdrop-blur-sm p-2">
        <img src="nav-shop.png" class="w-full h-full object-contain">
    </button>

    <button @click="currentTab = 'expense'" 
            :class="currentTab === 'expense' ? 'bg-white scale-110' : 'bg-white/80'" 
            class="w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all backdrop-blur-sm p-2">
        <img src="nav-money.png" class="w-full h-full object-contain">
    </button>

</div>
    </header>

    <div class="relative -mt-6 bg-[#f8fafc] rounded-t-[30px] px-5 pt-6 z-10 min-h-[500px] max-w-[480px] mx-auto">

        <div v-show="currentTab === 'itinerary'">
            
            <div class="weather-gradient rounded-2xl p-4 text-white mb-6 flex items-center justify-between shadow-lg ring-4 ring-white">
                <div>
                    <div class="text-sm opacity-90"><i class="fa-solid fa-location-arrow mr-1"></i> Êú≠Âπå Sapporo</div>
                    <div class="text-3xl font-bold mt-1">{{ weather.temp }}¬∞C</div>
                    <div class="text-xs opacity-80 mt-1">È´îÊÑü {{ weather.feelsLike }}¬∞C</div>
                </div>
                <div class="text-center">
                    <i :class="['fa-solid', weather.icon]" class="text-4xl animate-pulse"></i>
                    <div class="text-xs mt-2">{{ weather.text }}</div>
                </div>
            </div>

            <div class="flex space-x-4 overflow-x-auto no-scrollbar mb-6 pb-2">
                <div v-for="(day, index) in tripDays" :key="index" 
                     @click="selectedDateIndex = index"
                     :class="selectedDateIndex === index ? 'bg-blue-500 text-white shadow-blue-200' : 'bg-white text-gray-400'"
                     class="flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center shadow-sm transition-all cursor-pointer">
                    <span class="text-xs font-medium uppercase tracking-wider">{{ day.week }}</span>
                    <span class="text-2xl font-bold mt-1">{{ day.date }}</span>
                </div>
            </div>

            <div class="space-y-0 relative">
                <div class="absolute left-[26px] top-4 bottom-10 w-0.5 bg-gray-200 -z-0"></div>

                <div v-for="(item, index) in currentDayItinerary" :key="item.id" class="relative pb-8 group">
                    
                    <div v-if="selectedDateIndex === 0 && index === 0" class="pl-14 relative" @click="openMap(item.location)">
                        <div class="absolute left-0 top-0 w-14 flex flex-col items-center z-10">
                            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center ring-4 ring-[#f8fafc]">
                                <i class="fa-solid fa-plane-departure"></i>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-5 card-shadow border-l-4 border-blue-400">
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full">Ëà™Áè≠</span>
                                <span class="text-gray-400 text-xs">{{ item.time }}</span>
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg">{{ item.name }}</h3>
                            <div class="mt-2 flex justify-between text-sm text-gray-600">
                                <div><span class="text-gray-400">TPE</span> 12:30</div>
                                <i class="fa-solid fa-arrow-right text-gray-300"></i>
                                <div><span class="text-gray-400">CTS</span> 17:20</div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">{{ item.notes }}</p>
                        </div>
                    </div>

                    <div v-else class="pl-14 relative">
                         <div v-if="index > 0" class="absolute -top-6 left-14 flex items-center text-xs text-gray-400 bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">
                            <i :class="getTransportIcon(item.transportType)" class="mr-1"></i>
                            {{ item.travelTime }}
                        </div>
                        <div v-if="index === 0 && selectedDateIndex !== 0" class="absolute -top-6 left-14 flex items-center text-xs text-gray-400 bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">
                            <i class="fa-solid fa-hotel mr-1"></i> ÂæûÈ£ØÂ∫óÂá∫Áôº: {{ item.travelTime }}
                        </div>

                        <div class="absolute left-0 top-0 w-14 flex flex-col items-center z-10">
                            <div :class="getCategoryColor(item.category)" class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-md ring-4 ring-[#f8fafc] cursor-pointer" @click.stop="moveItem(index)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl p-4 card-shadow active:scale-95 transition-transform cursor-pointer" @click="openMap(item.name)">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-gray-800">{{ item.name }}</h3>
                                    <p class="text-xs text-gray-500 mt-1"><i class="fa-regular fa-clock mr-1"></i>{{ item.time }}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button @click.stop="editItinerary(item)" class="text-gray-300 hover:text-blue-500"><i class="fa-solid fa-pen-to-square"></i></button>
                                    <button @click.stop="deleteItineraryItem(index)" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2 mt-3">
                                <span class="text-[10px] px-2 py-1 rounded-md bg-gray-100 text-gray-500">{{ item.category }}</span>
                                <span v-if="item.ticket" class="text-[10px] px-2 py-1 rounded-md bg-yellow-50 text-yellow-600">
                                    <i class="fa-solid fa-ticket mr-1"></i>{{ item.ticket }}
                                </span>
                            </div>
                            <p v-if="item.notes" class="text-xs text-gray-500 mt-2 border-t pt-2 border-dashed border-gray-100">
                                {{ item.notes }}
                            </p>
                        </div>
                        
                        <div class="absolute -right-2 top-10 flex flex-col space-y-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button @click.stop="moveUp(index)" v-if="index > 0" class="w-6 h-6 bg-white shadow rounded-full text-blue-400 text-xs"><i class="fa-solid fa-chevron-up"></i></button>
                            <button @click.stop="moveDown(index)" v-if="index < currentDayItinerary.length - 1" class="w-6 h-6 bg-white shadow rounded-full text-blue-400 text-xs"><i class="fa-solid fa-chevron-down"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <button @click="showAddModal = true; isEditing = false; resetForm()" class="fixed bottom-24 right-6 w-14 h-14 bg-blue-500 text-white rounded-full shadow-xl shadow-blue-300 flex items-center justify-center text-2xl hover:scale-110 transition-transform z-40">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div class="bg-white rounded-2xl p-5 card-shadow">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-coins text-yellow-500 mr-2"></i> ÂåØÁéáÊèõÁÆó (‰ªäÊó•)</h3>
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <label class="text-xs text-gray-400 block mb-1">Êó•Âπ£ (JPY)</label>
                        <input type="number" v-model="currencyJpy" @input="convertCurrency" class="w-full bg-gray-50 rounded-lg px-3 py-2 text-lg font-bold outline-none focus:ring-2 focus:ring-blue-200">
                    </div>
                    <i class="fa-solid fa-right-left text-gray-300"></i>
                    <div class="flex-1">
                        <label class="text-xs text-gray-400 block mb-1">Âè∞Âπ£ (TWD)</label>
                        <input type="number" v-model="currencyTwd" readonly class="w-full bg-gray-50 rounded-lg px-3 py-2 text-lg font-bold text-gray-500">
                    </div>
                </div>
                <p class="text-[10px] text-gray-400 mt-2 text-right">
                    <i class="fa-solid fa-circle-check text-green-400 mr-1" v-if="exchangeRate > 0"></i>
                    {{ exchangeRateText }}
                </p>
            </div>

            <div class="bg-white rounded-2xl overflow-hidden card-shadow">
                <div class="bg-blue-50 px-5 py-3 border-b border-blue-100 flex justify-between items-center">
                    <h3 class="font-bold text-blue-800"><i class="fa-solid fa-plane mr-2"></i>Ëà™Áè≠Ë≥áË®ä (ÈÖ∑Ëà™ Scoot)</h3>
                </div>
                <div class="p-5 space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800">TPE</div>
                            <div class="text-xs text-gray-400">12:30</div>
                        </div>
                        <div class="flex-1 px-4 text-center">
                            <div class="text-xs text-blue-500 font-bold mb-1">TR892</div>
                            <div class="h-0.5 bg-gray-200 relative">
                                <i class="fa-solid fa-plane absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-blue-300"></i>
                            </div>
                            <div class="text-[10px] text-gray-400 mt-1">4h 50m</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800">CTS</div>
                            <div class="text-xs text-gray-400">17:20</div>
                        </div>
                    </div>
                    <div class="border-t border-dashed border-gray-200 my-2"></div>
                    <div class="flex items-center justify-between">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800">CTS</div>
                            <div class="text-xs text-gray-400">18:40</div>
                        </div>
                        <div class="flex-1 px-4 text-center">
                            <div class="text-xs text-blue-500 font-bold mb-1">TR893</div>
                            <div class="h-0.5 bg-gray-200 relative">
                                <i class="fa-solid fa-plane absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-blue-300 rotate-180"></i>
                            </div>
                            <div class="text-[10px] text-gray-400 mt-1">3h 40m</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800">TPE</div>
                            <div class="text-xs text-gray-400">22:20</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white rounded-2xl p-4 card-shadow flex flex-col">
                    <div class="flex items-center mb-3">
                         <i class="fa-solid fa-hotel text-2xl text-purple-400 mr-2"></i>
                         <h4 class="font-bold text-sm">‰ΩèÂÆøË≥áË®ä</h4>
                    </div>
                    <div class="space-y-3">
                        <div @click.stop="openMap('APA HOTEL SAPPORO')" class="border-l-2 border-purple-200 pl-2 cursor-pointer hover:bg-purple-50 transition-colors py-1">
                            <div class="font-bold text-xs text-gray-700">APA HOTEL SAPPORO</div>
                            <div class="text-[10px] text-purple-400 mt-0.5"><i class="fa-solid fa-location-dot mr-1"></i>Â∞éËà™</div>
                        </div>
                        <div @click.stop="openMap('„Çª„Éà„É´Ë±äÂπ≥Ôºì„ÉªÔºë')" class="border-l-2 border-purple-200 pl-2 cursor-pointer hover:bg-purple-50 transition-colors py-1">
                            <div class="font-bold text-xs text-gray-700">„Çª„Éà„É´Ë±äÂπ≥Ôºì„ÉªÔºë</div>
                            <div class="text-[10px] text-purple-400 mt-0.5"><i class="fa-solid fa-location-dot mr-1"></i>Â∞éËà™</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-4 card-shadow cursor-pointer hover:scale-[1.02] transition-transform" @click="openMap('Êú≠ÂπåËªäÁ´ô')">
                    <i class="fa-solid fa-train-subway text-2xl text-green-400 mb-2"></i>
                    <h4 class="font-bold text-sm">‰∫§ÈÄöË≥áË®ä</h4>
                    <p class="text-xs text-gray-400 mt-1">Êú≠ÂπåËªäÁ´ô</p>
                    <p class="text-[10px] text-blue-500 mt-2">ÈªûÊìäÂ∞éËà™ ></p>
                </div>
            </div>

            <div class="bg-red-50 rounded-2xl p-4 border border-red-100">
                <h4 class="font-bold text-red-600 mb-2">Á∑äÊÄ•ËÅØÁµ°</h4>
                <div class="flex justify-between text-sm">
                    <span><i class="fa-solid fa-user-shield mr-2"></i>Ë≠¶ÂØüÂ±Ä: 110</span>
                    <span><i class="fa-solid fa-truck-medical mr-2"></i>ÊïëË≠∑Ëªä: 119</span>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'shopping'" class="pb-20">
            <h2 class="text-xl font-bold text-gray-800 mb-4 px-2">ÂøÖË≤∑Ê∏ÖÂñÆ Wishlist</h2>
            <div class="grid grid-cols-2 gap-4">
                <div v-for="(item, index) in shoppingList" :key="index" class="bg-white rounded-2xl p-3 card-shadow relative">
                    <div class="aspect-square bg-gray-100 rounded-xl mb-2 overflow-hidden relative">
                         <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                         <div v-else class="w-full h-full flex items-center justify-center text-gray-300"><i class="fa-solid fa-image text-2xl"></i></div>
                    </div>
                    <h4 class="font-bold text-gray-700 text-sm">{{ item.name }}</h4>
                    <button @click="shoppingList.splice(index, 1)" class="absolute top-2 right-2 w-6 h-6 bg-red-100 text-red-500 rounded-full flex items-center justify-center text-xs"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <button @click="showShopModal = true" class="fixed bottom-24 right-6 w-14 h-14 bg-pink-500 text-white rounded-full shadow-xl shadow-pink-300 flex items-center justify-center text-2xl hover:scale-110 transition-transform z-40">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div v-show="currentTab === 'expense'" class="pb-20">
            <div class="bg-gradient-to-r from-blue-500 to-cyan-400 rounded-2xl p-6 text-white shadow-lg shadow-blue-200 mb-6">
                <div class="text-sm opacity-90">Á∏ΩËä±Ë≤ª (TWD)</div>
                <div class="text-4xl font-bold mt-1">$ {{ totalExpenseTWD }}</div>
                <div class="mt-4 flex justify-between text-xs opacity-80">
                    <span>ÁèæÈáë: {{ expenseCash }}</span>
                    <span>‰ø°Áî®Âç°: {{ expenseCard }}</span>
                </div>
            </div>

            <div class="space-y-3">
                <div v-for="(exp, index) in expenses" :key="index" class="bg-white rounded-xl p-4 card-shadow flex justify-between items-center relative group">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center mr-3 text-lg">
                            <i :class="getExpenseIcon(exp.category)" class="text-gray-500"></i>
                        </div>
                        <div>
                            <div class="font-bold text-gray-800">{{ exp.name }}</div>
                            <div class="text-xs text-gray-400">{{ exp.date }} ¬∑ {{ exp.payment }}</div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="text-right mr-3">
                            <div class="font-bold text-gray-800">¬•{{ exp.amount }}</div>
                            <div class="text-xs text-gray-400">Á¥Ñ ${{ Math.round(exp.amount * 0.218) }}</div>
                        </div>
                        <button @click="deleteExpense(index)" class="w-8 h-8 rounded-full bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-500 hover:text-white transition-colors">
                            <i class="fa-solid fa-trash-can text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
            <button @click="showExpModal = true" class="fixed bottom-24 right-6 w-14 h-14 bg-cyan-500 text-white rounded-full shadow-xl shadow-cyan-300 flex items-center justify-center text-2xl hover:scale-110 transition-transform z-40">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

    </div>

    <div v-if="showAddModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-slide-up">
            <h3 class="text-xl font-bold mb-4">{{ isEditing ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }}</h3>
            <div class="space-y-3">
                <select v-model="form.category" class="w-full bg-gray-50 p-3 rounded-lg border-none">
                    <option value="ÊôØÈªû">ÊôØÈªû</option>
                    <option value="ÁæéÈ£ü">ÁæéÈ£ü</option>
                    <option value="Ë≥ºÁâ©">Ë≥ºÁâ©</option>
                    <option value="‰ΩèÂÆø">‰ΩèÂÆø</option>
                    <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                </select>
                <input v-model="form.name" type="text" placeholder="ÂêçÁ®±" class="w-full bg-gray-50 p-3 rounded-lg border-none">
                
                <div class="bg-gray-50 rounded-lg p-3 flex items-center justify-between">
                    <div class="flex items-center text-gray-400">
                        <i class="fa-regular fa-clock mr-2"></i>
                        <span class="text-sm font-medium">ÊôÇÈñì</span>
                    </div>
                    <input v-model="form.time" type="time" class="bg-transparent border-none outline-none text-gray-800 font-bold text-right w-32">
                </div>

                <input v-if="form.category === 'ÊôØÈªû'" v-model="form.ticket" type="text" placeholder="ÈñÄÁ•®Ë≥áË®ä" class="w-full bg-gray-50 p-3 rounded-lg border-none">
                <textarea v-model="form.notes" placeholder="ÂÇôË®ª" class="w-full bg-gray-50 p-3 rounded-lg border-none h-20"></textarea>
            </div>
            <div class="mt-6 flex space-x-3">
                <button v-if="isEditing" @click="deleteItinerary" class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">Âà™Èô§</button>
                <button @click="showAddModal = false" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold">ÂèñÊ∂à</button>
                <button @click="saveItinerary" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-bold">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

    <div v-if="showShopModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Êñ∞Â¢ûË≥ºÁâ©Ê∏ÖÂñÆ</h3>
            <input v-model="shopForm.name" type="text" placeholder="ÂïÜÂìÅÂêçÁ®±" class="w-full bg-gray-50 p-3 rounded-lg mb-3">
            <label class="block w-full bg-gray-50 p-3 rounded-lg text-center text-gray-400 cursor-pointer border border-dashed border-gray-300">
                <i class="fa-solid fa-camera mr-2"></i>‰∏äÂÇ≥ÂúñÁâá
                <input type="file" @change="handleImageUpload" class="hidden" accept="image/*">
            </label>
            <div v-if="shopForm.image" class="mt-2 text-center text-xs text-green-500">ÂúñÁâáÂ∑≤ÈÅ∏Âèñ</div>
            <div class="mt-6 flex space-x-3">
                <button @click="showShopModal = false" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold">ÂèñÊ∂à</button>
                <button @click="saveShopItem" class="flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold">Êñ∞Â¢û</button>
            </div>
        </div>
    </div>

    <div v-if="showExpModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Êñ∞Â¢ûËä±Ë≤ª</h3>
            <div class="space-y-3">
                <select v-model="expForm.category" class="w-full bg-gray-50 p-3 rounded-lg">
                    <option value="È£≤È£ü">È£≤È£ü</option>
                    <option value="‰∫§ÈÄö">‰∫§ÈÄö</option>
                    <option value="Ë≥ºÁâ©">Ë≥ºÁâ©</option>
                    <option value="ÈñÄÁ•®">ÈñÄÁ•®</option>
                    <option value="‰ΩèÂÆø">‰ΩèÂÆø</option>
                    <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                </select>
                <input v-model="expForm.name" type="text" placeholder="È†ÖÁõÆÂêçÁ®±" class="w-full bg-gray-50 p-3 rounded-lg">
                <input v-model="expForm.amount" type="number" placeholder="ÈáëÈ°ç (JPY)" class="w-full bg-gray-50 p-3 rounded-lg">
                <div class="flex space-x-2">
                     <button @click="expForm.payment = 'ÁèæÈáë'" :class="expForm.payment === 'ÁèæÈáë' ? 'bg-cyan-100 text-cyan-600' : 'bg-gray-50 text-gray-400'" class="flex-1 py-2 rounded-lg text-sm">ÁèæÈáë</button>
                     <button @click="expForm.payment = '‰ø°Áî®Âç°'" :class="expForm.payment === '‰ø°Áî®Âç°' ? 'bg-cyan-100 text-cyan-600' : 'bg-gray-50 text-gray-400'" class="flex-1 py-2 rounded-lg text-sm">‰ø°Áî®Âç°</button>
                </div>
            </div>
            <div class="mt-6 flex space-x-3">
                <button @click="showExpModal = false" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold">ÂèñÊ∂à</button>
                <button @click="saveExpense" class="flex-1 bg-cyan-500 text-white py-3 rounded-xl font-bold">Á¥ÄÈåÑ</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, reactive, computed, ref, watch, onMounted } = Vue;

    // =========== Firebase Ë®≠ÂÆöÂçÄ ===========
    const firebaseConfig = {
        apiKey: "AIzaSyDx5V2CTQT576ZVf_nFsornau2w0VjJ1lY",
        authDomain: "hokkaido-trip-1b5dc.firebaseapp.com",
        projectId: "hokkaido-trip-1b5dc",
        storageBucket: "hokkaido-trip-1b5dc.firebasestorage.app",
        messagingSenderId: "26570489994",
        appId: "1:26570489994:web:3178fb7c98ad09a625ed73"
    };
    
    // ÂàùÂßãÂåñ Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // ===================================

    createApp({
        setup() {
            const currentTab = ref('itinerary');
            const selectedDateIndex = ref(0);

            // ÊóÖÁ®ãÊó•Êúü
            const tripDays = [
                { week: 'WED', date: '19' },
                { week: 'THU', date: '20' },
                { week: 'FRI', date: '21' },
                { week: 'SAT', date: '22' },
                { week: 'SUN', date: '23' },
                { week: 'MON', date: '24' },
                { week: 'TUE', date: '25' }
            ];

            // --- Ë≥áÊñôËÆäÊï∏ ---
            const defaultItinerary = Array(7).fill().map(() => []); 
            defaultItinerary[0] = [
                 { id: 1, category: 'Ëà™Áè≠', name: 'Êê≠‰πòÈÖ∑Ëà™ÂâçÂæÄÂåóÊµ∑ÈÅì', time: '12:30', notes: 'Ëà™Áè≠ TR892', transportType: 'flight' }
            ];

            const itineraryData = reactive(defaultItinerary);
            
            const shoppingList = reactive([
                { name: 'ËºâÂÖ•Èõ≤Á´ØË≥áÊñô‰∏≠...', image: null }
            ]);
            
            const expenses = reactive([
                { category: 'ÂÖ∂‰ªñ', name: 'ËºâÂÖ•‰∏≠...', date: '-', amount: 0, payment: '-' }
            ]);

            // =========== Èõ≤Á´ØÂêåÊ≠•ÈÇèËºØ ===========
            
            onMounted(() => {
                // A. Áõ£ËÅΩË°åÁ®ã
                db.collection('hokkaido_trip').doc('itinerary').onSnapshot((doc) => {
                    if (doc.exists) {
                        const cloudData = doc.data().list;
                        cloudData.forEach((dayData, index) => {
                            itineraryData[index] = dayData;
                        });
                    }
                });

                // B. Áõ£ËÅΩË≥ºÁâ©
                db.collection('hokkaido_trip').doc('shopping').onSnapshot((doc) => {
                    if (doc.exists) {
                        shoppingList.splice(0, shoppingList.length, ...doc.data().list);
                    } else {
                        shoppingList.splice(0, shoppingList.length); 
                    }
                });

                // C. Áõ£ËÅΩËä±Ë≤ª
                db.collection('hokkaido_trip').doc('expenses').onSnapshot((doc) => {
                    if (doc.exists) {
                        expenses.splice(0, expenses.length, ...doc.data().list);
                    } else {
                        expenses.splice(0, expenses.length);
                    }
                });
            });

            // =========== Ëá™Âãï‰∏äÂÇ≥ ===========
            
            watch(itineraryData, (newVal) => {
                db.collection('hokkaido_trip').doc('itinerary').set({ list: newVal });
            }, { deep: true });

            watch(shoppingList, (newVal) => {
                db.collection('hokkaido_trip').doc('shopping').set({ list: newVal });
            }, { deep: true });

            watch(expenses, (newVal) => {
                db.collection('hokkaido_trip').doc('expenses').set({ list: newVal });
            }, { deep: true });

            // ===============================

            const currentDayItinerary = computed(() => {
                return itineraryData[selectedDateIndex.value] || [];
            });

            const currentHeaderImage = computed(() => {
                const imageMap = {
                    'itinerary': 'header-bg.png',
                    'info': 'header-info.png',
                    'shopping': 'header-shop.png',
                    'expense': 'header-money.png'
                };
                return imageMap[currentTab.value] || 'header-bg.png';
            });

            const showAddModal = ref(false);
            const isEditing = ref(false);
            const editingId = ref(null);
            const form = reactive({ category: 'ÊôØÈªû', name: '', time: '', ticket: '', notes: '' });
            
            const showShopModal = ref(false);
            const shopForm = reactive({ name: '', image: null });

            const showExpModal = ref(false);
            const expForm = reactive({ category: 'È£≤È£ü', name: '', amount: '', payment: 'ÁèæÈáë' });

            // =========== ÂåØÁéáÊèõÁÆó (Âç≥ÊôÇÁâà Logic) ===========
            
            const currencyJpy = ref(1000); 
            const currencyTwd = ref(0);
            const exchangeRate = ref(0.218); // È†êË®≠ÂÄº (Ëê¨‰∏ÄÊ≤íÁ∂≤Ë∑ØÊôÇÁî®)
            const exchangeRateText = ref('ÈÄ£Á∑ö‰∏≠...'); 

            // 1. ÊäìÂèñÂç≥ÊôÇÂåØÁéáÂáΩÂºè
            const fetchExchangeRate = async () => {
                try {
                    // üëáüëáüëá Ë´ãÊääÈÄôË£°ÊèõÊàê‰Ω†ÁöÑ API Key üëáüëáüëá
                    const apiKey = '59e0d17c27c49c5a6cc332c6'; 
                    // üëÜüëÜüëÜ Ë®òÂæó‰øùÁïôÂºïËôü üëÜüëÜüëÜ

                    const res = await fetch(`https://v6.exchangerate-api.com/v6/${apiKey}/latest/JPY`);
                    const data = await res.json();

                    if (data.result === 'success') {
                        // ÊàêÂäüÊäìÂà∞ÔºÅÊõ¥Êñ∞ÂåØÁéá (TWD)
                        exchangeRate.value = data.conversion_rates.TWD;
                        exchangeRateText.value = `Âç≥ÊôÇÂåØÁéá: ${exchangeRate.value}`;
                        convertCurrency(); // ÈáçÊñ∞ÁÆó‰∏ÄÊ¨°ÈáëÈ°ç
                    } else {
                        exchangeRateText.value = 'ËºâÂÖ•Â§±ÊïóÔºå‰ΩøÁî®ÂèÉËÄÉÂåØÁéá: 0.218';
                    }
                } catch (e) {
                    console.error(e);
                    exchangeRateText.value = 'ÁÑ°Ê≥ïÈÄ£Á∑öÔºå‰ΩøÁî®ÂèÉËÄÉÂåØÁéá: 0.218';
                }
            };

            // 2. Âü∑Ë°åÊèõÁÆó
            const convertCurrency = () => {
                currencyTwd.value = Math.round(currencyJpy.value * exchangeRate.value);
            };

            // 3. Áï´Èù¢ËºâÂÖ•ÊôÇÔºåÁ´ãÂàªÂéªÊäìÂåØÁéá
            fetchExchangeRate();

            const resetForm = () => {
                Object.assign(form, { category: 'ÊôØÈªû', name: '', time: '', ticket: '', notes: '' });
            };

            const editItinerary = (item) => {
                isEditing.value = true;
                editingId.value = item.id;
                Object.assign(form, item);
                showAddModal.value = true;
            };

            const saveItinerary = () => {
                if (isEditing.value) {
                    const list = itineraryData[selectedDateIndex.value];
                    const index = list.findIndex(i => i.id === editingId.value);
                    if (index !== -1) {
                        Object.assign(list[index], form);
                    }
                } else {
                    const transportOptions = ['walk', 'car', 'bus'];
                    const randomTransport = transportOptions[Math.floor(Math.random() * transportOptions.length)];
                    const randomTime = Math.floor(Math.random() * 20 + 5) + 'ÂàÜÈêò';

                    itineraryData[selectedDateIndex.value].push({
                        id: Date.now(),
                        ...form,
                        travelTime: randomTime,
                        transportType: randomTransport
                    });
                }
                showAddModal.value = false;
            };

            const deleteItineraryItem = (index) => {
                if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãË°åÁ®ãÂóéÔºü')) {
                    itineraryData[selectedDateIndex.value].splice(index, 1);
                }
            };
             const deleteItinerary = () => {
                if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãË°åÁ®ãÂóéÔºü')) {
                    const list = itineraryData[selectedDateIndex.value];
                    const index = list.findIndex(i => i.id === editingId.value);
                    list.splice(index, 1);
                    showAddModal.value = false;
                }
            };

            const moveUp = (index) => {
                const list = itineraryData[selectedDateIndex.value];
                [list[index - 1], list[index]] = [list[index], list[index - 1]];
            };
            const moveDown = (index) => {
                const list = itineraryData[selectedDateIndex.value];
                [list[index + 1], list[index]] = [list[index], list[index + 1]];
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 400;
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        shopForm.image = canvas.toDataURL('image/jpeg', 0.6);
                    };
                };
            };

            const saveShopItem = () => {
                if(shopForm.name) {
                    shoppingList.push({ ...shopForm });
                    shopForm.name = ''; shopForm.image = null;
                    showShopModal.value = false;
                }
            };

            const saveExpense = () => {
                if(expForm.name && expForm.amount) {
                    expenses.push({
                        ...expForm,
                        date: tripDays[selectedDateIndex.value].week + ' ' + tripDays[selectedDateIndex.value].date,
                        amount: parseInt(expForm.amount)
                    });
                    showExpModal.value = false;
                    expForm.name = ''; expForm.amount = '';
                }
            };
            
            const deleteExpense = (index) => {
                 if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜËä±Ë≤ªÁ¥ÄÈåÑÂóéÔºü')) {
                    expenses.splice(index, 1);
                }
            };

            const totalExpenseTWD = computed(() => {
                return Math.round(expenses.reduce((sum, item) => sum + (item.amount * 0.218), 0));
            });
            const expenseCash = computed(() => {
                 let total = expenses.filter(i => i.payment === 'ÁèæÈáë').reduce((sum, i) => sum + (i.amount * 0.218), 0);
                 return Math.round(total);
            });
            const expenseCard = computed(() => {
                 let total = expenses.filter(i => i.payment === '‰ø°Áî®Âç°').reduce((sum, i) => sum + (i.amount * 0.218), 0);
                 return Math.round(total);
            });

            const weather = reactive({ temp: '--', feelsLike: '--', text: 'ËºâÂÖ•‰∏≠...', icon: 'fa-snowflake' });
            const fetchWeather = async () => {
                try {
                    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=43.0618&longitude=141.3545&current=temperature_2m,apparent_temperature,weather_code&timezone=Asia%2FTokyo');
                    const data = await res.json();
                    weather.temp = Math.round(data.current.temperature_2m);
                    weather.feelsLike = Math.round(data.current.apparent_temperature);
                    const code = data.current.weather_code;
                    if (code <= 3) { weather.text = 'Â§öÈõ≤ÊôÇÊô¥'; weather.icon = 'fa-cloud-sun'; }
                    else if (code <= 48) { weather.text = 'Ëµ∑Èúß'; weather.icon = 'fa-smog'; }
                    else if (code <= 67) { weather.text = '‰∏ãÈõ®'; weather.icon = 'fa-cloud-rain'; }
                    else if (code <= 77 || code <= 86) { weather.text = '‰∏ãÈõ™'; weather.icon = 'fa-snowflake'; }
                    else { weather.text = 'Êö¥È¢®Èõ™'; weather.icon = 'fa-wind'; }
                } catch (e) { weather.text = 'ÁÑ°Ê≥ïËºâÂÖ•'; }
            };
            fetchWeather();

            const openMap = (location) => {
                if(location.includes('ÂâçÂæÄ') || location.includes('Ëà™Áè≠')) return;
                // ‰øÆÊ≠£ÂæåÁöÑ Google Maps URL
                const query = encodeURIComponent(location + ' ÂåóÊµ∑ÈÅì');
                window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
            };

            const getCategoryColor = (cat) => {
                const map = { 'ÊôØÈªû': 'bg-green-400', 'ÁæéÈ£ü': 'bg-orange-400', 'Ë≥ºÁâ©': 'bg-pink-400', '‰ΩèÂÆø': 'bg-purple-400', 'Ëà™Áè≠': 'bg-blue-400', 'ÂÖ∂‰ªñ': 'bg-gray-400' };
                return map[cat] || 'bg-blue-400';
            };
            const getCategoryIcon = (cat) => {
                 const map = { 'ÊôØÈªû': 'fa-camera', 'ÁæéÈ£ü': 'fa-utensils', 'Ë≥ºÁâ©': 'fa-bag-shopping', '‰ΩèÂÆø': 'fa-bed', 'Ëà™Áè≠': 'fa-plane', 'ÂÖ∂‰ªñ': 'fa-star' };
                 return `fa-solid ${map[cat] || 'fa-map-pin'}`;
            };
            const getTransportIcon = (type) => {
                const map = { 'walk': 'fa-person-walking', 'car': 'fa-car', 'bus': 'fa-bus', 'train': 'fa-train' };
                return `fa-solid ${map[type] || 'fa-person-walking'}`;
            };
            const getExpenseIcon = (cat) => {
                 const map = { 'È£≤È£ü': 'fa-utensils', '‰∫§ÈÄö': 'fa-train', 'Ë≥ºÁâ©': 'fa-bag-shopping', 'ÈñÄÁ•®': 'fa-ticket', '‰ΩèÂÆø': 'fa-bed' };
                 return `fa-solid ${map[cat] || 'fa-coins'}`;
            };

            return {
                currentTab, selectedDateIndex, tripDays, itineraryData, currentDayItinerary,
                showAddModal, isEditing, form, editItinerary, saveItinerary, deleteItinerary, deleteItineraryItem, resetForm,
                moveUp, moveDown,
                currencyJpy, currencyTwd, convertCurrency,
                showShopModal, shoppingList, shopForm, handleImageUpload, saveShopItem,
                showExpModal, expenses, expForm, saveExpense, deleteExpense, totalExpenseTWD, expenseCash, expenseCard,
                openMap, getCategoryColor, getCategoryIcon, getTransportIcon, getExpenseIcon,
                currentHeaderImage, weather,exchangeRateText,exchangeRate
            };
        }
    }).mount('#app');
</script>
</body>
</html>


